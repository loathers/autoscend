#!/bin/bash
HEADER="# THIS FILE IS GENERATED BY BUILD/assemble.sh
# DO NOT EDIT THIS FILE DIRECTLY. EDIT THE .DAT FILES IN THE /BUILD/ FOLDER THEN RUN assemble.sh
"

for DIR in ./*/; do
	DIR_STRIP_LEAD=${DIR#*/}
	DIR_CLEAN=${DIR_STRIP_LEAD%/}
	OUT="../RELEASE/data/autoscend_${DIR_CLEAN}.txt"
	echo "$HEADER" > $OUT
	cat $DIR/header.txt >> $OUT
	SAVEIFS=$IFS
	IFS=$(echo -en "\n\b")
  for FILENAME in $(ls ${DIR}*.dat | sort -i); do
		SLOT=${FILENAME::-4}
		SLOT=${SLOT##*/}
		NUM=0
		cat $FILENAME | while read LINE; do
			if [[ $LINE == \#* ]]; then
				echo "$LINE" >> $OUT
			else
				echo "$SLOT	$NUM	$LINE" >> $OUT
				let "NUM += 1"
			fi
		done
		echo "" >> $OUT
	done
	IFS=$SAVEIFS
done
